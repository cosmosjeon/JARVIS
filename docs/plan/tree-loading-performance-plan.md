# 트리 로딩 성능 개선 계획

## 목적
- 트리 기록 목록과 활성 트리 첫 화면이 3초 이내로 표시되도록 개선합니다.
- 현재 대비 네트워크 전송량과 브라우저 파싱 시간을 절반 이하로 줄입니다.

## 현상 요약
- 첫 진입 시 `loadTrees`가 두 차례 호출되며, 트리마다 모든 노드를 함께 내려받아 응답 크기가 큽니다.
- UI 계층에서도 동일한 대용량 응답을 다시 요청하여 네트워크·파싱 비용이 반복됩니다.
- Supabase 쿼리가 최대 1만 개 노드를 한 번에 가져오도록 설정되어 있어 데이터가 늘수록 시간이 기하급수적으로 증가합니다.

## 원인 분석
1. **데이터 요청 과부하**: 목록 표시에도 노드 전체를 포함한 응답을 사용합니다.
2. **중복 호출**: 초기 트리 결정 과정과 UI 렌더링에서 같은 API를 여러 번 호출합니다.
3. **로컬 상태 재가공 비용**: 내려받은 대용량 JSON을 다시 가공하면서 메모리 복사와 정리가 반복됩니다.

## 개선 전략
1. **데이터 분리**: 트리 목록은 메타데이터만, 선택된 트리는 노드 데이터를 별도 요청으로 분리합니다.
2. **호출 공유**: 초기 트리 결정을 위한 목록 응답을 UI와 공유하여 재호출을 막습니다.
3. **지연 로딩**: 사용자가 실제로 열람할 때만 노드 데이터를 내려받고, 전환 중에는 로딩 인디케이터를 보여줍니다.
4. **계측 강화**: 응답 크기·소요 시간을 로깅하여 개선 효과를 확인할 수 있도록 합니다.

## 단계별 작업 계획

### 1. 데이터 계층 정비
- `fetchTreesWithNodes`를 두 갈래로 나눠 `fetchTreeSummaries`(ID·제목·타임스탬프)와 `fetchTreeNodes(treeId)`를 도입합니다.
- `useTreeDataSource`에서 새로운 경량 API를 노출하고, 기존 노드 포함 함수는 선택된 트리 로딩 전용으로 축소합니다.
- 저장 로직(`saveTreeMetadata`, `saveTreeNodes`)은 그대로 유지해 회귀를 방지합니다.

### 2. 컨트롤러 리팩터링
- `useTreeDataController`의 초기 로딩 흐름을 조정하여, 한 번 받은 트리 요약 리스트를 상태로 유지하고 `loadActiveTree`에 전달합니다.
- 새 트리 생성 시 빈 노드 세트를 로컬에서 세팅한 뒤 비동기로 저장하도록 변경해, 서버 재조회 없이 화면이 뜨도록 합니다.
- 요청 실패 시 기존 에러 처리·초기화 경로를 유지하며, 상태 플래그(`initializingTree`, `isTreeSyncing`)가 즉시 반영되도록 확인합니다.

### 3. UI 업데이트
- `HierarchicalForceTree`와 관련 하위 컴포넌트가 트리 선택용 데이터로 ID·제목만 참조하도록 수정합니다.
- 사용자가 트리를 선택할 때 `loadActiveTree`가 노드 요청을 수행하도록 이벤트 흐름을 명확히 합니다.
- 로딩 중에는 스켈레톤 또는 간결한 메시지를 표시해 사용자 체감 시간을 줄입니다.

### 4. 품질 보증 및 계측
- Supabase 쿼리 응답 시간을 로깅하거나 브라우저에서 `performance.mark`를 활용해 개선 전후를 비교합니다.
- 단위 테스트: 새 데이터 소스 함수가 올바른 형태의 데이터를 반환하는지 확인합니다.
- 통합 테스트: 초기 진입 시 네트워크 호출 수와 응답 페이로드 크기가 줄었는지 측정 스크립트를 추가합니다.

## 예상 효과
- 초기 네트워크 응답 크기 70% 이상 절감.
- 렌더링 전까지 필요한 JSON 파싱 시간이 절반 이하로 감소.
- 사용자는 첫 화면을 1~2초 안에 확인 가능해집니다.

## 리스크 및 대응
- **데이터 정합성**: 목록과 상세 응답이 다를 경우를 대비해 선택 시 최신 데이터를 다시 확인하는 방어 로직을 둡니다.
- **캐싱 갱신**: 다른 장치에서 트리가 변경되면 목록이 늦게 갱신될 수 있으므로, 포그라운드 진입 시 목록을 재요청합니다.
- **추가 호출 증가**: 트리 간 이동이 잦은 경우 노드 요청이 늘 수 있으므로, 단기 캐시(Map)로 최근 데이터를 재활용합니다.

## 측정 및 완료 기준
- Lighthouse 또는 `performance.now()` 기반 측정에서 초기 로딩이 3초 이하인지 확인합니다.
- 초기 렌더링까지 발생한 네트워크 요청이 1회(요약 요청) + 선택 시 1회(노드 요청)를 넘지 않는지 검사합니다.
- QA 체크리스트에 따라 기능 회귀가 없음을 검증합니다.

## 후속 일정 제안
1. 1일차: 데이터 계층 분리 및 기본 테스트 작성
2. 2일차: 컨트롤러·UI 리팩터링 및 계측 코드 추가
3. 3일차: 성능 측정, QA, 회귀 테스트 수행 후 배포 검토

